<!DOCTYPE html>
<html lang='zh-cn'>
<head>
  <meta charset='utf-8' />
  <title>index</title>
</head>
<body>
<script type='module'>
  import { add, subtract, multiply, divide, remain } from '../src/exactMath.js'

  const reg = /\([^()]+\)/g
  let expression = '11 + (12 - 10)'

  // expression = expression.replace(/\s+/g, '')

  // console.log(expression)

  // const result = expression.match(reg)
  //
  // const arithmetic = result.forEach(data => {
  //
  // })

  const operates = {
    '+': add,
    '-': subtract,
    '*': multiply,
    '/': divide,
    '%': remain
  }

  // 简单的四则运算不包括括号
  const arithmetic = (expression) => {
    // 用空格拆分表达式
    expression = expression.replace(/(?<=\d|\.)([%*/+-])/g, ' $1 ')
    // 移除冗余空格
    expression = expression.replace(/\s{2,}/, ' ')
    // 移除首尾空格
    expression = expression.trim()
    // 把表达式拆分成数组
    let arr = expression.split(/\s+/g)

    if (arr.length <= 0) {
      return 0
    }


    let index = -1
    let result = null
    do {
      index = arr.findIndex(item => ['*', '/', '%'].includes(item))
      if (index < 0) {
        break
      }
      result = operates[arr[index]](arr[index - 1], arr[index + 1])
      arr.splice(index - 1, 3, result)
    } while (true)

    result = 0

    console.log(expression, arr)

    for (let i = 0; i < arr.length; i++) {
      if (arr[i] === '+' || arr[i] === '-') {
        continue
      }

      result = operates[arr[i - 1] || '+'](result, arr[i])
    }


    return result
  }

  const exactMath = (arithmeticStr) => {

    const rBrackets = /\([^()]+\)/g

    while (rBrackets.test(arithmeticStr)) {
      arithmeticStr = arithmeticStr.replace(rBrackets, (express) => {
        return arithmetic(express.replace(/[()]/g, ''))
      })
    }
    return arithmetic(arithmeticStr)
  }

  console.log(exactMath('+10 - -3 + +4'))

</script>
</body>
</html>
